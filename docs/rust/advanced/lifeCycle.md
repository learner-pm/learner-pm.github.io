# 深入生命周期

https://www.vgter.net/archives/4526

## 生命周期省略规则

在`Rust`中，生命周期省略规则用于简化代码，不需要显示的声明生命周期。对于普通函数，`Rust`提供了3条默认的生命周期推断规则，它们可以帮助编译器推断函数签名中的生命周期，而不需要手动指定

1. 每个输入参数的生命周期都可以隐时地与其函数签名相关联
2. 如果函数有一个返回值，且只有一个输入引用参数，那么返回值的生命周期会被推断为与输入参数的生命周期相同
3. 如果函数有多个输入引用参数，并且其中一个时`self`，则返回值的生命周期会与`self`的生命周期相关联、

如下例

```rust
fn fn_elision(x: &i32) -> &i32 { x }
```

会被`Rust`自动推断为

```rust
fn fn_elision<'a>(x: &'a i32) -> &'a i32 { x }
```

为什么这样推断

- `x`的类型时`&i32`，它的生命周期时`'a`
- 函数的返回值类型时`&i32`，没有额外的输入引用，所以`Rust`会假设返回值的生命周期与输入参数`x`相同

### 闭包

对于闭包，`Rust`会根据使用闭包的环境来推断其生命周期。闭包的生命周期是由闭包本身的参数和返回值的生命周期决定的，而不是像函数那样严格按照省略规则推断

闭包的参数生命周期推断有以下几个关键点

1. 闭包的参数生命周期
   - 闭包的参数生命周期会由函数的类型决定。闭包的生命周期推断通常与函数类似，但闭包的生命周期时根据它的上下文来决定的
2. 闭包的返回值生命周期
